<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submitted Maintenance Checklists</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --primary:#2f80ed;
    --danger:#e74c3c;
    --bg:#f5f7fa;
    --card:#ffffff;
    --border:#e0e0e0;
}
* { box-sizing:border-box; font-family:"Segoe UI", Tahoma, Arial, sans-serif; }
body { margin:0; padding:20px; background:var(--bg); }
.container {
    max-width:1100px;
    margin:auto;
    background:var(--card);
    padding:25px;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,.1);
}
h1 { text-align:center; color:var(--primary); }

.top-bar {
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:10px;
    margin-bottom:15px;
}
input[type="search"], input[type="date"] {
    padding:8px;
    border-radius:6px;
    border:1px solid var(--border);
}
button {
    padding:10px 18px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    background:var(--primary);
    color:white;
}
.btn-delete { background:var(--danger); }
.btn-back { background:#6c757d; }

table { width:100%; border-collapse:collapse; }
th, td { padding:12px; border-bottom:1px solid var(--border); text-align:left; }
th { background:#f0f4ff; }
tr:hover { background:#f9fbff; }
.empty { text-align:center; padding:30px; color:#777; }

.modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    justify-content:center;
    align-items:center;
    z-index:999;
}
.modal-content {
    background:white;
    width:90%;
    max-width:700px;
    max-height:85vh;
    overflow-y:auto;
    border-radius:10px;
    padding:25px;
}
.modal h2 { margin-top:0; color:var(--primary); }
.modal-section { margin-bottom:20px; }
.modal-section h3 {
    border-left:4px solid var(--primary);
    padding-left:10px;
}
.checklist-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:10px;
}
.check-item {
    background:#f9fbff;
    padding:8px;
    border-radius:6px;
    border:1px solid var(--border);
}
.close-btn { background:#6c757d; margin-top:10px; }
</style>

<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<div class="container">
<h1>Submitted Maintenance Checklists</h1>

<div class="top-bar">
    <input type="search" id="searchInput" placeholder="Search technician / asset / department">
    <div>
        <label>From <input type="date" id="fromDate"></label>
        <label>To <input type="date" id="toDate"></label>
    </div>
    <div>
        <button id="exportExcelBtn">Export Excel</button>
        <button id="exportPdfBtn">Export PDF</button>
        <button class="btn-back" onclick="history.back()">Back</button>
    </div>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Technician</th>
<th>Department</th>
<th>Asset</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="emptyMessage" class="empty" style="display:none;">No checklist submitted yet.</div>
</div>

<!-- MODAL -->
<div class="modal" id="viewModal">
<div class="modal-content">
<h2>Checklist Details</h2>

<div class="modal-section">
<p><strong>Technician:</strong> <span id="mTech"></span></p>
<p><strong>Department:</strong> <span id="mDept"></span></p>
<p><strong>Asset Tag:</strong> <span id="mAsset"></span></p>
<p><strong>Date:</strong> <span id="mDate"></span></p>
</div>

<div class="modal-section">
<h3>Checklist Items Completed</h3>
<div class="checklist-grid" id="mChecklist"></div>
</div>

<div class="modal-section">
<h3>Remarks</h3>
<p id="mRemarks"></p>
</div>

<button class="close-btn" onclick="closeModal()">Close</button>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB8JJysKYC8bF1LNEKxQVgmAECSNDtJ4k",
  authDomain: "maintenance-b02f5.firebaseapp.com",
  databaseURL: "https://maintenance-b02f5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maintenance-b02f5",
  storageBucket: "maintenance-b02f5.firebasestorage.app",
  messagingSenderId: "1082192524878",
  appId: "1:1082192524878:web:6c58aec531f7743f45b51f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tableBody = document.getElementById("tableBody");
const emptyMessage = document.getElementById("emptyMessage");
const modal = document.getElementById("viewModal");
const computerChecklistItems = [
  "Clean keyboard & mouse",
  "Clean monitor screen",
  "Clean internal dust",
  "Check cooling fans",
  "Inspect cables & ports",
  "Check power supply",
  "Operating system updates",
  "Antivirus updated",
  "Malware scan completed",
  "Disk cleanup",
  "Disk health check",
  "Startup programs reviewed",
  "Network connectivity tested",
  "Firewall enabled",
  "Backup verified",
  "User password policy checked"
];

const printerChecklistItems = [
  "Printer exterior cleaned",
  "Internal dust cleaned",
  "Paper path cleaned",
  "Pickup and feed rollers cleaned",
  "Scanner glass cleaned",
  "ADF glass cleaned",
  "Toner or ink level checked",
  "Drum unit condition checked",
  "Fuser unit condition checked",
  "Waste toner checked",
  "Paper feed tested",
  "No abnormal noise",
  "Duplex unit tested",
  "ADF tested",
  "Test page printed",
  "Print quality normal",
  "Network connectivity tested",
  "Printer IP reachable",
  "Driver checked or updated",
  "Power cable in good condition",
  "Printer environment safe"
];
    
let data = [];

function fetchData(){
    db.ref("checklists").once("value", snap=>{
        const val = snap.val();
        data = val ? Object.entries(val).map(([key,v])=>({key,...v})) : [];
        renderTable(data);
    });
}

function renderTable(list){
    tableBody.innerHTML = "";
    if(!list.length){ emptyMessage.style.display="block"; return; }
    emptyMessage.style.display="none";

    list.forEach((item,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${item.date||"-"}</td>
            <td>${item.technician||"-"}</td>
            <td>${item.department||"-"}</td>
            <td>${item.asset||"-"}</td>
            <td>
                <button onclick="viewItem(${i})">View</button>
                <button class="btn-delete" onclick="deleteItem(${i})">Delete</button>
            </td>
        `;
        tableBody.appendChild(tr);
    });
}

function viewItem(i){
    const item = data[i];

    mTech.textContent = item.technician || "-";
    mDept.textContent = item.department || "-";
    mAsset.textContent = item.asset || "-";
    mDate.textContent = item.date || "-";
    mRemarks.textContent = item.remarks || "None";

    const list = document.getElementById("mChecklist");
    list.innerHTML = "";

    // Auto-detect checklist type
    const isPrinter = printerChecklistItems.some(c =>
        (item.checklist || []).includes(c)
    );

    const masterList = isPrinter
        ? printerChecklistItems
        : computerChecklistItems;

    masterList.forEach(name => {
        const div = document.createElement("div");
        div.className = "check-item";
        div.textContent = item.checklist?.includes(name)
            ? `✅ ${name}`
            : `❌ ${name}`;
        list.appendChild(div);
    });

    modal.style.display = "flex";
}

function closeModal(){ modal.style.display="none"; }

function deleteItem(i){
    if(!confirm("Delete this checklist?")) return;
    db.ref("checklists/"+data[i].key).remove().then(fetchData);
}

searchInput.addEventListener("input", e=>{
    const v = e.target.value.toLowerCase();
    renderTable(data.filter(d=>
        d.technician?.toLowerCase().includes(v) ||
        d.asset?.toLowerCase().includes(v) ||
        d.department?.toLowerCase().includes(v)
    ));
});

function getFiltered(){
    const f = fromDate.value, t = toDate.value;
    return (!f||!t)? data : data.filter(d=>d.date>=f && d.date<=t);
}

exportExcelBtn.onclick = ()=>{
    const list = getFiltered();
    if(!list.length) return alert("No data.");
    const rows = list.map(d=>({
        Date:d.date, Technician:d.technician,
        Department:d.department, Asset:d.asset,
        Checklist:(d.checklist||[]).join(", "),
        Remarks:d.remarks
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb,ws,"Maintenance");
    XLSX.writeFile(wb,"Maintenance_Report.xlsx");
};

exportPdfBtn.onclick = ()=>{
    const list = getFiltered();
    if(!list.length) return alert("No data.");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    list.forEach(d=>{
        doc.text(`Asset: ${d.asset}`,10,y); y+=6;
        doc.text(`Technician: ${d.technician}`,10,y); y+=6;
        doc.text(`Checklist: ${(d.checklist||[]).join(", ")}`,10,y,{maxWidth:180});
        y+=15;
        if(y>270){ doc.addPage(); y=20; }
    });
    doc.save("Maintenance_Report.pdf");
};

fetchData();
</script>

</body>
</html>


