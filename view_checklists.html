<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Submitted Maintenance Checklists</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
    --primary:#2f80ed;
    --danger:#e74c3c;
    --bg:#f5f7fa;
    --card:#ffffff;
    --border:#e0e0e0;
}

* { box-sizing:border-box; font-family:"Segoe UI", Tahoma, Arial, sans-serif; }
body { margin:0; padding:20px; background:var(--bg); }
.container { max-width:1100px; margin:auto; background:var(--card); padding:25px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.1); }
h1 { text-align:center; color:var(--primary); }

.top-bar {
    display:flex; flex-wrap:wrap; justify-content:space-between; gap:10px; margin-bottom:15px;
}
input[type="search"], input[type="date"] { padding:8px; border-radius:6px; border:1px solid var(--border); margin-right:5px; }
button { padding:10px 18px; border:none; border-radius:6px; cursor:pointer; background:var(--primary); color:white; margin-right:5px; }
.btn-delete { background:var(--danger); }
.btn-back { background:#6c757d; }

table { width:100%; border-collapse:collapse; }
th, td { padding:12px; border-bottom:1px solid var(--border); text-align:left; }
th { background:#f0f4ff; }
tr:hover { background:#f9fbff; }
.empty { text-align:center; padding:30px; color:#777; }

/* ===== MODAL ===== */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:999; }
.modal-content { background:white; width:90%; max-width:700px; max-height:85vh; overflow-y:auto; border-radius:10px; padding:25px; }
.modal h2 { margin-top:0; color:var(--primary); }
.modal-section { margin-bottom:20px; }
.modal-section h3 { border-left:4px solid var(--primary); padding-left:10px; }
.checklist-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
.check-item { background:#f9fbff; padding:8px; border-radius:6px; border:1px solid var(--border); }
.close-btn { background:#6c757d; margin-top:10px; }
</style>

<!-- SheetJS for Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
<!-- jsPDF for PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<div class="container">
<h1>Submitted Maintenance Checklists</h1>

<div class="top-bar">
    <input type="search" id="searchInput" placeholder="Search technician / asset">
    <div>
        <label>From: <input type="date" id="fromDate"></label>
        <label>To: <input type="date" id="toDate"></label>
    </div>
    <button id="exportExcelBtn">Export Excel</button>
    <button id="exportPdfBtn">Export PDF</button>
    <button class="btn-back" onclick="location.href='maintenance_form.html'">Back to Form</button>
</div>

<table>
<thead>
<tr>
<th>Date</th>
<th>Technician</th>
<th>Department</th>
<th>Asset</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="emptyMessage" class="empty" style="display:none;">No checklist submitted yet.</div>
</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="viewModal">
<div class="modal-content">
<h2>Checklist Details</h2>

<div class="modal-section">
<p><strong>Technician:</strong> <span id="mTech"></span></p>
<p><strong>Department:</strong> <span id="mDept"></span></p>
<p><strong>Asset Tag:</strong> <span id="mAsset"></span></p>
<p><strong>Date:</strong> <span id="mDate"></span></p>
</div>

<div class="modal-section">
<h3>Checklist</h3>
<div class="checklist-grid" id="mChecklist"></div>
</div>

<div class="modal-section">
<h3>Remarks</h3>
<p id="mRemarks"></p>
</div>

<button class="close-btn" onclick="closeModal()">Close</button>
</div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8JJysKYC8bF1LNEKxQVgmAECSNDtJ4k",
  authDomain: "maintenance-b02f5.firebaseapp.com",
  databaseURL: "https://maintenance-b02f5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maintenance-b02f5",
  storageBucket: "maintenance-b02f5.firebasestorage.app",
  messagingSenderId: "1082192524878",
  appId: "1:1082192524878:web:6c58aec531f7743f45b51f",
  measurementId: "G-GTNHPXQJH3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tableBody = document.getElementById("tableBody");
const emptyMessage = document.getElementById("emptyMessage");
const modal = document.getElementById("viewModal");

let data = [];
let checklistItems = [
    "Clean keyboard & mouse","Clean monitor screen","Clean internal dust","Check cooling fans","Inspect cables & ports","Check power supply",
    "Operating system updates","Antivirus updated","Malware scan completed","Disk cleanup","Disk health check","Startup programs reviewed",
    "Network connectivity tested","Firewall enabled","Backup verified","User password policy checked"
];

// Fetch Firebase data
function fetchData() {
    db.ref('checklists').once('value', snapshot => {
        const obj = snapshot.val();
        data = obj ? Object.entries(obj).map(([key, value]) => ({ key, ...value })) : [];
        renderTable(data);
    });
}

function renderTable(list) {
    tableBody.innerHTML = "";
    if (!list.length) { emptyMessage.style.display="block"; return; }
    emptyMessage.style.display="none";

    list.forEach((item,i)=>{
        const row=document.createElement("tr");
        row.innerHTML=`
            <td>${item.date||"-"}</td>
            <td>${item.technician||"-"}</td>
            <td>${item.department||"-"}</td>
            <td>${item.asset||"-"}</td>
            <td>
                <button onclick="viewItem(${i})">View</button>
                <button class="btn-delete" onclick="deleteItem(${i})">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function viewItem(index){
    const item=data[index];
    document.getElementById("mTech").textContent=item.technician;
    document.getElementById("mDept").textContent=item.department;
    document.getElementById("mAsset").textContent=item.asset;
    document.getElementById("mDate").textContent=item.date;
    document.getElementById("mRemarks").textContent=item.remarks||"None";

    const list=document.getElementById("mChecklist");
    list.innerHTML="";
    checklistItems.forEach(name=>{
        const checked=item.checklist?.includes(name);
        const div=document.createElement("div");
        div.className="check-item";
        div.innerHTML=checked?`✅ ${name}`:`❌ ${name}`;
        list.appendChild(div);
    });

    modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

function deleteItem(index){
    if(!confirm("Delete this checklist?")) return;
    const item=data[index];
    db.ref('checklists/'+item.key).remove().then(()=>fetchData()).catch(err=>alert("Error deleting: "+err));
}

// Search
document.getElementById("searchInput").addEventListener("input", e=>{
    const val=e.target.value.toLowerCase();
    renderTable(data.filter(d=>d.technician?.toLowerCase().includes(val)||
                               d.asset?.toLowerCase().includes(val)||
                               d.department?.toLowerCase().includes(val)));
});

// Date Filter
function getFilteredByDate(){
    const from=document.getElementById("fromDate").value;
    const to=document.getElementById("toDate").value;
    if(!from||!to) return data;
    return data.filter(item=>item.date>=from && item.date<=to);
}

// ===== Export Excel (✅/❌ per checklist) =====
document.getElementById("exportExcelBtn").addEventListener("click", ()=>{
    const filtered=getFilteredByDate();
    if(!filtered.length){ alert("No data in this date range."); return; }

    const ws_data = filtered.map(item=>{
        const obj={Date:item.date, Technician:item.technician, Department:item.department, Asset:item.asset, Remarks:item.remarks};
        checklistItems.forEach(name=>obj[name]=item.checklist?.includes(name)?"✅":"❌");
        return obj;
    });

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"Checklists");
    XLSX.writeFile(wb,`Maintenance_Report_${document.getElementById("fromDate").value}_${document.getElementById("toDate").value}.xlsx`);
});

// ===== Export PDF (colored ✅/❌) =====
document.getElementById("exportPdfBtn").addEventListener("click", ()=>{
    const filtered = getFilteredByDate();
    if(!filtered.length){ alert("No data in this date range."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','pt');
    doc.setFontSize(14);
    doc.text("Maintenance Report", 40, 40);

    const head = ["Date","Technician","Department","Asset","Remarks", ...checklistItems];
    const body = filtered.map(item=>{
        const row = [item.date,item.technician,item.department,item.asset,item.remarks||"-"];
        checklistItems.forEach(name=>row.push(item.checklist?.includes(name)?"✅":"❌"));
        return row;
    });

    doc.autoTable({
        head: [head],
        body: body,
        startY: 60,
        styles: { fontSize: 9, cellPadding: 4, overflow: 'linebreak' },
        headStyles: { fillColor: [47,128,237], textColor: 255, fontStyle:'bold' },
        columnStyles: head.reduce((acc,col,i)=>{
            acc[i]={cellWidth:i>4?40:'auto'}; // checklist columns narrow, main info auto
            return acc;
        }, {}),
        didParseCell: function(data) {
            if(data.row.section==='body'){
                if(data.cell.text[0] === "✅"){
                    data.cell.styles.textColor = [0,150,0]; // green
                    data.cell.styles.fontStyle = 'bold';
                } else if(data.cell.text[0] === "❌"){
                    data.cell.styles.textColor = [200,0,0]; // red
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        },
        margin: { left: 20, right: 20 },
        theme: 'grid'
    });

    doc.save(`Maintenance_Report_${document.getElementById("fromDate").value}_${document.getElementById("toDate").value}.pdf`);
});

fetchData();
</script>

</body>
</html>

